<!DOCTYPE html>
<html>
<head>
    <title>Euler Repay Signer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Euler v2 Repay (0.00001 ETH) - Wallet Sign</h2>
    <button onclick="connectAndSign()">Connect Wallet & Sign/Repay</button>
    <pre id="output"></pre>

    <script>
        // Config (update if needed)
        const USER_ADDRESS = "0x963392e2058c7dbfdd177e8d9b4b576fe28c6bbd"; // e.g., "0x963..." - replace with yours
        const EVC_ADDRESS = "0x5301c7dD20bD945D2013b48ed0DEE3A284ca8989".toLowerCase();
        const PERMIT2_ADDRESS = "0x000000000022D473030F116dDEE9F6B43aC78BA3".toLowerCase();
        const WETH_ADDRESS = "0x4200000000000000000000000000000000000006".toLowerCase();
        const DTOKEN_ADDRESS = "0x859160db5841e5cfb8d3f144c6b3381a85a4b410".toLowerCase(); // Your dToken

        const REPAY_AMOUNT = 10000000000000n; // 0.00001 ETH wei
        const PERMIT_AMOUNT = REPAY_AMOUNT + (REPAY_AMOUNT / 1000n) + 1n; // Buffer
        const EXPIRATION = 0n; // No exp (like original)
        const SIG_DEADLINE = BigInt(Math.floor(Date.now() / 1000) + 1800); // 30 min

        // ABIs
        const PERMIT2_ABI = [
            "function nonces(address owner) external view returns (uint256)",
            "function permit(address owner, ( (address token, uint256 amount, uint48 expiration, uint48 nonce) details, address spender, uint256 sigDeadline ) permitSingle, bytes signature) external"
        ];
        const DTOKEN_ABI = ["function repay(uint256 amount, address onBehalfOf) external"];
        const EVC_ABI = [
            "struct BatchItem { address targetContract; address onBehalfOfAccount; uint256 value; bytes data; }",
            "function batch(BatchItem[] calldata items) external"
        ];

        // EIP-712 for Permit2
        const PERMIT2_DOMAIN = {
            name: "Permit2",
            version: "1",
            chainId: 8453,
            verifyingContract: PERMIT2_ADDRESS
        };
        const PERMIT2_TYPES = {
            PermitDetails: [
                { name: "token", type: "address" },
                { name: "amount", type: "uint256" },
                { name: "expiration", type: "uint48" },
                { name: "nonce", type: "uint48" }
            ],
            PermitSingle: [
                { name: "details", type: "PermitDetails" },
                { name: "spender", type: "address" },
                { name: "sigDeadline", type: "uint256" }
            ]
        };

        let provider, signer, permit2, dToken, evc;

        async function connectAndSign() {
            const output = document.getElementById('output');
            output.textContent = 'Connecting...\n';

            if (typeof window.ethereum === 'undefined') {
                output.textContent += 'MetaMask/Rabby not detected!\n';
                return;
            }

            try {
                // Request Base chain
                await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x2105' }] }); // 8453 hex

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                const address = await signer.getAddress();
                if (address.toLowerCase() !== USER_ADDRESS.toLowerCase()) {
                    throw new Error('Wallet mismatch! Update USER_ADDRESS.');
                }
                output.textContent += `Connected: ${address}\n`;

                // Init contracts
                permit2 = new ethers.Contract(PERMIT2_ADDRESS, PERMIT2_ABI, signer);
                dToken = new ethers.Contract(DTOKEN_ADDRESS, DTOKEN_ABI, signer);
                evc = new ethers.Contract(EVC_ADDRESS, EVC_ABI, signer);

                // Fetch nonce
                const nonce = await permit2.nonces(address);
                output.textContent += `Nonce: ${nonce}\n`;

                // PermitSingle
                const permitDetails = {
                    token: WETH_ADDRESS,
                    amount: PERMIT_AMOUNT.toString(),
                    expiration: Number(EXPIRATION),
                    nonce: Number(nonce)
                };
                const permitSingle = {
                    details: permitDetails,
                    spender: DTOKEN_ADDRESS,
                    sigDeadline: Number(SIG_DEADLINE)
                };

                // Sign typed data (wallet popup)
                output.textContent += 'Signing Permit2 typed data...\n';
                const signature = await signer.signTypedData(PERMIT2_DOMAIN, PERMIT2_TYPES, permitSingle);
                output.textContent += `Signature: ${signature}\n`;

                // Encode calls
                const permitData = permit2.interface.encodeFunctionData("permit", [address, permitSingle, signature]);
                const repayData = dToken.interface.encodeFunctionData("repay", [REPAY_AMOUNT, address]);

                // Batch items
                const items = [{
                    targetContract: PERMIT2_ADDRESS,
                    onBehalfOfAccount: address,
                    value: "0",
                    data: "0x" + permitData.slice(2) // Hex without 0x
                }, {
                    targetContract: DTOKEN_ADDRESS,
                    onBehalfOfAccount: address,
                    value: "0",
                    data: "0x" + repayData.slice(2)
                }];

                // Encode batch calldata
                const batchData = evc.interface.encodeFunctionData("batch", [items]);
                output.textContent += `Batch Calldata: ${batchData}\n`;

                // Send tx (wallet popup for gas/sign)
                output.textContent += 'Sending batch tx...\n';
                const tx = await signer.sendTransaction({
                    to: EVC_ADDRESS,
                    data: batchData,
                    gasLimit: 250000 // Adjust if needed
                });
                output.textContent += `Tx Hash: ${tx.hash}\nView: https://basescan.org/tx/${tx.hash}\n`;

                const receipt = await tx.wait();
                output.textContent += `Status: ${receipt.status === 1 ? 'Success! Repaid 0.00001 ETH.' : 'Failed'}\n`;
            } catch (error) {
                output.textContent += `Error: ${error.message}\n`;
            }
        }
    </script>
</body>
</html>